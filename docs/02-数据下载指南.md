# 数据下载指南

## 概述

`RawDataDownloader` 是 Binance 官方公开数据下载工具，支持两种数据类型：

1. **AggTrades** (原始交易数据) - 聚合交易记录
2. **Klines** (标准 K 线数据) - OHLCV 行情数据

所有数据使用 **Zstandard (zstd)** 压缩存储，支持流式解压，内存高效。

---

## 文件结构

```
src/data_loader/
├── raw_downloader.py        # 数据下载器 (支持 AggTrades 和 Klines)
├── bar_generator.py         # Bar 生成器 (Dollar/Volume/Tick/Custom)
└── __init__.py              # 模块初始化
```

---

## 快速开始

### 1. 下载 AggTrades (原始交易数据)

```python
from src.data_loader import RawDataDownloader

downloader = RawDataDownloader()

# 下载原始交易数据
downloader.download_agg_trades(
    symbol="BTCUSDT",
    start_date="2026-01-20",
    end_date="2026-01-26"
)

# 数据保存到: data/raw_data/BTCUSDT/aggTrades/2026-01/*.csv.zst
```

### 2. 下载 Klines (K 线数据)

```python
from src.data_loader import RawDataDownloader

downloader = RawDataDownloader()

# 下载 K 线数据 (支持 1m, 5m, 15m, 30m, 1h, 4h, 1d 等)
downloader.download_klines(
    symbol="BTCUSDT",
    start_date="2026-01-20",
    end_date="2026-01-26",
    interval="1m"  # 可选: 1m, 5m, 15m, 30m, 1h, 4h, 1d
)

# 数据保存到: data/raw_data/BTCUSDT/klines/1m/2026-01/*.csv.zst
```

---

## 数据字段

### AggTrades 字段
- `timestamp` - Unix 毫秒级时间戳
- `price` - 成交价格
- `amount` - 成交量 (基础资产)
- `is_buyer_maker` - 买方是否为 Maker
- `trade_id` - 聚合交易 ID
- `first_trade_id` - 首笔原始交易 ID
- `last_trade_id` - 末笔原始交易 ID
- `num_trades` - 包含的原始交易笔数

### Klines 字段
- `open_time` - K 线开盘时间
- `open` - 开盘价
- `high` - 最高价
- `low` - 最低价
- `close` - 收盘价
- `volume` - 成交量 (基础资产)
- `close_time` - K 线收盘时间
- `quote_volume` - 成交额 (计价资产)
- `count` - 成交笔数
- `taker_buy_volume` - Taker 买入量
- `taker_buy_quote_volume` - Taker 买入额

---

## 高级用法

### 解压并查看数据

```python
import pandas as pd
import zstandard as zstd

# 解压 AggTrades 数据
zst_file = "data/raw_data/BTCUSDT/aggTrades/2026-01/BTCUSDT-aggTrades-2026-01-20.csv.zst"

dctx = zstd.ZstdDecompressor()
with open(zst_file, 'rb') as f_in:
    reader = dctx.stream_reader(f_in)
    df = pd.read_csv(reader)

print(f"总行数: {len(df)}")
print(df.head())
```

---

## 特性

✅ **高效压缩** - 使用 Zstandard 流式压缩，内存占用低  
✅ **进度显示** - tqdm 进度条显示下载进度  
✅ **错误处理** - 自动跳过缺失数据，详细日志记录  
✅ **跨日期支持** - 自动处理多日期数据合并  
✅ **灵活配置** - 支持自定义下载目录和数据类型

```python
config = DownloadConfig(
    symbol="BTC/USDT",
    start_date="2025-12-30",
    end_date="2025-12-31",
    bar_type="dollar",
    threshold=1000000,  # 每累计 100 万 USDT 聚合成一个 Bar
    proxies=PROXIES,
)

downloader = CryptoDataDownloader(config)
df = downloader.download()

# 数据自动保存到: data/btcusdt-dollar1000000.csv
```

---

## 配置参数详解

### `DownloadConfig` 参数

| 参数            | 类型 | 默认值       | 说明                                         |
| --------------- | ---- | ------------ | -------------------------------------------- |
| `symbol`        | str  | "BTC/USDT"   | 交易对符号                                   |
| `start_date`    | str  | "2025-06-20" | 开始日期（ISO 格式，UTC）                    |
| `end_date`      | str  | "2025-12-31" | 结束日期（ISO 格式，UTC）                    |
| `bar_type`      | str  | "time"       | Bar 类型: "time", "tick", "volume", "dollar" |
| `timeframe`     | str  | "5m"         | Time Bar 专用：时间周期                      |
| `threshold`     | int  | 1000         | Tick/Volume/Dollar Bar 专用：阈值            |
| `exchange_name` | str  | "binance"    | 交易所名称                                   |
| `market_type`   | str  | "spot"       | 市场类型: "spot" 或 "futures"                |
| `limit`         | int  | 1000         | 每次请求的数据量                             |
| `proxies`       | dict | None         | 代理设置（可选）                             |
| `output_dir`    | Path | None         | 输出目录（默认：项目根目录/data）            |

---

## 数据格式

所有数据均为 **Binance 风格的 12 列 CSV 格式**：

| 列名                         | 说明                   | 数据类型 |
| ---------------------------- | ---------------------- | -------- |
| Open time                    | 开盘时间（毫秒时间戳） | int64    |
| Open price                   | 开盘价                 | float    |
| High price                   | 最高价                 | float    |
| Low price                    | 最低价                 | float    |
| Close price                  | 收盘价                 | float    |
| Volume                       | 成交量（Base Asset）   | float    |
| Close time                   | 收盘时间（毫秒时间戳） | int64    |
| Quote asset volume           | 成交额（Quote Asset）  | float    |
| Number of trades             | 成交笔数               | int      |
| Taker buy base asset volume  | 主动买入成交量         | float    |
| Taker buy quote asset volume | 主动买入成交额         | float    |
| Ignore                       | 忽略字段               | float    |

---

## 核心功能特性

### 1. 自动重试机制

网络请求失败时自动重试（最多 5 次），并使用指数退避策略。

### 2. 进度条显示

使用 `tqdm` 显示下载进度，实时显示已下载数据量和时间。

### 3. UTC 时间处理

所有时间均使用 UTC 时区，确保数据一致性。

### 4. 数据去重

自动去除重复数据并按时间排序。

### 5. 数据验证

自动将数值列转换为合适的数据类型。

---

## 使用建议

### Time Bar

- **推荐使用场景**: 传统量化策略、回测
- **优点**: 数据获取快速，标准化
- **数据量**: 适中

### Tick Bar

- **推荐使用场景**: 高频策略、订单流分析
- **优点**: 更好地反映市场活跃度
- **数据量**: 大（请使用较短时间范围，如 1-7 天）
- **建议阈值**: 500-2000 笔

### Volume Bar

- **推荐使用场景**: 基于成交量的策略
- **优点**: 更好地捕捉市场参与度
- **数据量**: 大（请使用较短时间范围）
- **建议阈值**: BTC 50-200，ETH 500-2000

### Dollar Bar

- **推荐使用场景**: 基于资金流的策略
- **优点**: 更好地反映市场流动性
- **数据量**: 大（请使用较短时间范围）
- **建议阈值**: 50 万 - 200 万 USDT

---

## 注意事项

1. **Tick/Volume/Dollar Bar 数据量巨大**
   - 建议使用 **1-7 天** 的时间范围进行测试
   - 下载完整历史数据可能需要 **数小时到数天**

2. **速率限制**
   - 自动遵守交易所的速率限制
   - 如遇频繁限速，可适当增加请求间隔

3. **代理设置**
   - 如果在国内使用，建议配置代理
   - 如不需要代理，设置 `proxies=None`

4. **时间范围**
   - 时间使用 ISO 格式：`"2025-12-31"`
   - 所有时间均为 UTC 时区

5. **数据存储**
   - 数据默认保存到项目根目录的 `data/` 文件夹
   - 可通过 `output_dir` 参数自定义

---

## 扩展开发

### 添加新的 Bar 类型

1. 在 `CryptoDataDownloader` 类中添加新的聚合方法：
   ```python
   def _aggregate_custom_bars(self, trades: List[Dict]) -> pd.DataFrame:
       # 自定义聚合逻辑
       pass
   ```

2. 在 `download()` 方法中添加分支：
   ```python
   elif self.config.bar_type == "custom":
       return self._download_custom_bar()
   ```

### 支持其他交易所

只需修改 `exchange_name` 参数即可：

```python
config = DownloadConfig(
    exchange_name="okx",  # 或 "huobi", "kraken" 等
    symbol="BTC/USDT",
    # ...
)
```

---

## 常见问题

**Q: 如何验证数据完整性？**

A: 
- 检查数据的时间连续性
- 对比不同来源的数据
- 使用 `df.info()` 查看数据质量

**Q: 支持期货合约数据吗？**

A: 
- 支持，设置 `market_type="futures"` 即可

---

