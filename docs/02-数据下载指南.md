# 数据下载指南

本指南详细介绍如何使用 `get_btcusdt_data.py` 脚本下载加密货币历史数据。

## 📖 目录

- [快速开始](#快速开始)
- [脚本参数详解](#脚本参数详解)
- [时间范围配置](#时间范围配置)
- [时间周期配置](#时间周期配置)
- [代理配置](#代理配置)
- [数据格式说明](#数据格式说明)
- [常见问题](#常见问题)

## 🚀 快速开始

### 基本使用

```bash
python script/get_btcusdt_data.py
```

默认行为：
- 交易对：BTC/USDT
- 交易所：Binance
- 时间范围：2025-06-20 至 2025-12-31
- 时间周期：5 分钟、15 分钟、30 分钟
- 输出目录：`data/`

### 输出示例

```
正在下载 5m 数据: 2025-06-20 至 2025-12-31
100%|████████████████| 34500/34500 [01:23<00:00, 412.45it/s]
数据已保存到: data/btc-usdt-5m.csv
总行数: 56160

正在下载 15m 数据: 2025-06-20 至 2025-12-31
100%|████████████████| 11500/11500 [00:28<00:00, 401.23it/s]
数据已保存到: data/btc-usdt-15m.csv
总行数: 18720

正在下载 30m 数据: 2025-06-20 至 2025-12-31
100%|████████████████| 5750/5750 [00:14<00:00, 395.67it/s]
数据已保存到: data/btc-usdt-30m.csv
总行数: 9360
```

## ⚙️ 脚本参数详解

### 核心配置变量

打开 `script/get_btcusdt_data.py`，你会看到以下配置区域：

```python
# ==================== 配置区域 ====================

# 交易对配置
SYMBOL = 'BTC/USDT'
EXCHANGE_NAME = 'binance'

# 时间范围（UTC 时间）
START_DATE = '2025-06-20'
END_DATE = '2025-12-31'

# 输出目录
OUTPUT_DIR = 'data'

# 时间周期配置（可多选）
TIMEFRAME_CONFIG = [
    {'timeframe': '5m', 'label': '5分钟'},
    {'timeframe': '15m', 'label': '15分钟'},
    {'timeframe': '30m', 'label': '30分钟'},
]

# 代理配置（国内用户可能需要）
PROXIES = {
    'http': 'http://127.0.0.1:7890',
    'https': 'http://127.0.0.1:7890'
}

# ==================== 配置区域结束 ====================
```

### 参数说明

| 参数 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `SYMBOL` | str | 交易对名称 | `'BTC/USDT'`, `'ETH/USDT'` |
| `EXCHANGE_NAME` | str | 交易所名称 | `'binance'`, `'okx'`, `'huobi'` |
| `START_DATE` | str | 开始日期（UTC） | `'2024-01-01'` |
| `END_DATE` | str | 结束日期（UTC） | `'2024-12-31'` |
| `OUTPUT_DIR` | str | 数据保存目录 | `'data'`, `'./historical_data'` |
| `TIMEFRAME_CONFIG` | list | 时间周期列表 | 见下方详解 |
| `PROXIES` | dict/None | HTTP 代理配置 | `None` 表示不使用代理 |

## ⏰ 时间范围配置

### 修改时间范围

根据你的回测需求修改：

```python
# 示例 1：下载最近 3 个月数据
START_DATE = '2024-10-01'
END_DATE = '2024-12-31'

# 示例 2：下载整个 2024 年数据
START_DATE = '2024-01-01'
END_DATE = '2024-12-31'

# 示例 3：下载最近 7 天数据（用于调试）
from datetime import datetime, timedelta
END_DATE = datetime.now().strftime('%Y-%m-%d')
START_DATE = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
```

### 时区注意事项

- **脚本使用 UTC 时间**（协调世界时）
- 如果你在东八区（北京时间），请**减去 8 小时**换算

**示例：**
- 想下载北京时间 2024-01-01 08:00:00 之后的数据
- UTC 时间应为 2024-01-01 00:00:00
- 脚本中设置 `START_DATE = '2024-01-01'`

## 📊 时间周期配置

### 可用时间周期

CCXT 支持的常见时间周期：

| 周期代码 | 说明 | 适用场景 |
|----------|------|----------|
| `1m` | 1 分钟 | 高频策略、剥头皮 |
| `5m` | 5 分钟 | 短线策略（默认） |
| `15m` | 15 分钟 | 中短线策略 |
| `30m` | 30 分钟 | 中线策略 |
| `1h` | 1 小时 | 波段策略 |
| `4h` | 4 小时 | 趋势跟踪 |
| `1d` | 1 天 | 长线投资 |

### 配置多个时间周期

```python
TIMEFRAME_CONFIG = [
    {'timeframe': '1m', 'label': '1分钟'},
    {'timeframe': '5m', 'label': '5分钟'},
    {'timeframe': '15m', 'label': '15分钟'},
    {'timeframe': '1h', 'label': '1小时'},
    {'timeframe': '1d', 'label': '1天'},
]
```

脚本会依次下载所有配置的时间周期，生成对应的 CSV 文件：

```
data/btc-usdt-1m.csv
data/btc-usdt-5m.csv
data/btc-usdt-15m.csv
data/btc-usdt-1h.csv
data/btc-usdt-1d.csv
```

### 只下载单个时间周期

如果你只需要 5 分钟数据：

```python
TIMEFRAME_CONFIG = [
    {'timeframe': '5m', 'label': '5分钟'},
]
```

## 🌐 代理配置

### 国内用户配置代理

由于 Binance 在国内访问受限，建议配置代理：

```python
# 使用 Clash/V2Ray 等代理工具（默认端口 7890）
PROXIES = {
    'http': 'http://127.0.0.1:7890',
    'https': 'http://127.0.0.1:7890'
}
```

### 自定义代理端口

如果你的代理端口不是 7890：

```python
# Shadowsocks 通常使用 1080 端口
PROXIES = {
    'http': 'http://127.0.0.1:1080',
    'https': 'http://127.0.0.1:1080'
}

# SOCKS5 代理（需要 PySocks 库）
PROXIES = {
    'http': 'socks5://127.0.0.1:1080',
    'https': 'socks5://127.0.0.1:1080'
}
```

### 不使用代理

如果你在国外或使用 VPN：

```python
PROXIES = None
```

### 验证代理是否生效

运行脚本时检查输出：

```bash
# 有代理：下载速度正常（300-500 it/s）
100%|████████████████| 56160/56160 [02:15<00:00, 412.45it/s]

# 无代理/代理失败：连接超时或速度极慢（<10 it/s）
  5%|█                | 2800/56160 [05:30<1:45:00, 8.45it/s]
```

## 📄 数据格式说明

### CSV 文件结构

下载的 CSV 文件包含以下列：

| 列名 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `timestamp` | int | Unix 毫秒时间戳 | `1718841600000` |
| `datetime` | str | 可读时间（UTC） | `2025-06-20 00:00:00` |
| `open` | float | 开盘价 | `66500.23` |
| `high` | float | 最高价 | `66750.89` |
| `low` | float | 最低价 | `66450.12` |
| `close` | float | 收盘价 | `66680.45` |
| `volume` | float | 成交量（BTC） | `123.456` |

### 示例数据行

```csv
timestamp,datetime,open,high,low,close,volume
1718841600000,2025-06-20 00:00:00,66500.23,66750.89,66450.12,66680.45,123.456
1718841900000,2025-06-20 00:05:00,66680.45,66820.12,66670.34,66780.67,98.234
1718842200000,2025-06-20 00:10:00,66780.67,66850.00,66720.50,66800.12,105.678
```

### 数据完整性检查

脚本会自动打印数据统计信息：

```
数据已保存到: data/btc-usdt-5m.csv
总行数: 56160
时间跨度: 2025-06-20 00:00:00 至 2025-12-31 23:55:00
缺失K线: 0
```

如果出现缺失 K 线，可能是：
- 交易所维护期间无数据
- 网络中断导致部分数据未下载
- 该时间段交易暂停

**解决方法**：重新运行脚本，CCXT 会自动跳过已下载的部分。

## 🔧 进阶用法

### 下载其他交易对

```python
# 下载以太坊数据
SYMBOL = 'ETH/USDT'

# 下载 SOL 数据
SYMBOL = 'SOL/USDT'

# 下载 BNB 数据
SYMBOL = 'BNB/USDT'
```

输出文件名会自动适配：
- `data/eth-usdt-5m.csv`
- `data/sol-usdt-5m.csv`
- `data/bnb-usdt-5m.csv`

### 使用其他交易所

```python
# OKX 交易所
EXCHANGE_NAME = 'okx'

# Huobi 交易所
EXCHANGE_NAME = 'huobi'

# Bybit 交易所
EXCHANGE_NAME = 'bybit'
```

**注意**：不同交易所的 API 限制和可用交易对可能不同。

### 批量下载多个交易对

修改脚本底部的主函数：

```python
if __name__ == "__main__":
    symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT']
    
    for symbol in symbols:
        SYMBOL = symbol
        print(f"\n{'='*60}")
        print(f"正在下载 {SYMBOL} 数据")
        print(f"{'='*60}\n")
        
        for config in TIMEFRAME_CONFIG:
            download_data(
                symbol=SYMBOL,
                timeframe=config['timeframe'],
                start_date=START_DATE,
                end_date=END_DATE,
                output_dir=OUTPUT_DIR,
                proxies=PROXIES
            )
```

## ❓ 常见问题

### Q1: 下载速度很慢怎么办？

**A1：** 
1. 检查代理是否配置正确
2. 更换代理节点（选择延迟低的节点）
3. 减少时间范围或时间周期数量
4. 避开交易所 API 高峰期（UTC 00:00-02:00）

### Q2: 出现 "ccxt.errors.RequestTimeout" 错误

**A2：**
```python
# 增加超时时间（脚本中已内置，可手动调整）
exchange = ccxt.binance({
    'timeout': 30000,  # 默认 30 秒，可改为 60000（60秒）
    'proxies': PROXIES,
})
```

### Q3: 数据下载中断怎么办？

**A3：** 重新运行脚本，CCXT 会自动从中断处继续下载（基于时间戳去重）。

### Q4: 如何验证数据质量？

**A4：** 使用 Pandas 检查：

```python
import pandas as pd

df = pd.read_csv('data/btc-usdt-5m.csv')

# 检查空值
print(df.isnull().sum())

# 检查时间连续性
df['datetime'] = pd.to_datetime(df['datetime'])
time_diff = df['datetime'].diff()
print(f"时间间隔异常: {(time_diff != pd.Timedelta(minutes=5)).sum()}")

# 检查价格合理性
print(df.describe())
```

### Q5: 能否下载更早的历史数据？

**A5：** 
- Binance 现货数据可追溯到 2017 年
- 但注意：数据量大（1 分钟级别约 500 万行/年）
- 建议分批下载（按季度或月度）

```python
# 分批下载示例
START_DATE = '2024-01-01'
END_DATE = '2024-03-31'  # 先下载 Q1
```

### Q6: 脚本报错 "ModuleNotFoundError: No module named 'ccxt'"

**A6：** 安装缺失依赖：

```bash
pip install ccxt pandas tqdm
```

---

📌 **提示**：数据下载完成后，继续阅读 [回测框架手册](./03-回测框架手册.md) 学习如何使用这些数据进行策略回测。
