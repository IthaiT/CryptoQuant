# å›æµ‹æ¡†æ¶ä½¿ç”¨æ‰‹å†Œ

æœ¬æ‰‹å†Œè¯¦ç»†ä»‹ç» CryptoQuant å›æµ‹æ¡†æ¶çš„æ¶æ„ã€æ ¸å¿ƒç»„ä»¶å’Œé«˜çº§ç”¨æ³•ã€‚

## ğŸ“– ç›®å½•

- [æ¡†æ¶æ¶æ„](#æ¡†æ¶æ¶æ„)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [BacktestEngine ä½¿ç”¨](#backtestengine-ä½¿ç”¨)
- [quick_backtest å¿«æ·å‡½æ•°](#quick_backtest-å¿«æ·å‡½æ•°)
- [æ•°æ®åŠ è½½å™¨](#æ•°æ®åŠ è½½å™¨)
- [å¯è§†åŒ–å›¾è¡¨](#å¯è§†åŒ–å›¾è¡¨)
- [æ€§èƒ½åˆ†æå™¨](#æ€§èƒ½åˆ†æå™¨)
- [é«˜çº§é…ç½®](#é«˜çº§é…ç½®)

## ğŸ—ï¸ æ¡†æ¶æ¶æ„

CryptoQuant å›æµ‹æ¡†æ¶åŸºäº **Backtrader** æ„å»ºï¼Œæä¾›äº†å®Œæ•´çš„é‡åŒ–å›æµ‹å·¥ä½œæµï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è„šæœ¬å±‚                             â”‚
â”‚              (script/run_backtest.py)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å›æµ‹å¼•æ“å±‚                                â”‚
â”‚            (src/backtest/engine.py)                      â”‚
â”‚  â€¢ BacktestEngine: æ ¸å¿ƒå¼•æ“                              â”‚
â”‚  â€¢ quick_backtest(): å¿«æ·å‡½æ•°                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç­–ç•¥å±‚          â”‚      â”‚   å¯è§†åŒ–å±‚           â”‚
â”‚ (src/strategy/)  â”‚      â”‚ (src/backtest/)     â”‚
â”‚ â€¢ StrategyBase   â”‚      â”‚ â€¢ visualizer.py     â”‚
â”‚ â€¢ RSIStrategy    â”‚      â”‚ â€¢ realtime_chart.py â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Backtrader åº•å±‚                        â”‚
â”‚  â€¢ Cerebro: å›æµ‹å¼•æ“                                     â”‚
â”‚  â€¢ DataFeed: æ•°æ®æº                                      â”‚
â”‚  â€¢ Analyzers: æ€§èƒ½åˆ†æå™¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹

1. **æ•°æ®åŠ è½½**ï¼š`data_loader.py` è¯»å– CSV â†’ Pandas DataFrame â†’ Backtrader DataFeed
2. **ç­–ç•¥åˆå§‹åŒ–**ï¼šç”¨æˆ·ç­–ç•¥ç»§æ‰¿ `StrategyBase`ï¼Œæ³¨å†Œåˆ° Cerebro
3. **å›æµ‹æ‰§è¡Œ**ï¼šBacktrader é€æ ¹ K çº¿è°ƒç”¨ç­–ç•¥çš„ `next()` æ–¹æ³•
4. **ä¿¡å·ç”Ÿæˆ**ï¼šç­–ç•¥å‘å‡º `Position.LONG/SHORT/EXIT` ä¿¡å·
5. **è®¢å•æ‰§è¡Œ**ï¼šBacktrader æ¨¡æ‹Ÿå¸‚ä»·å•æ‰§è¡Œ
6. **å®æ—¶å¯è§†åŒ–**ï¼šæ¯æ ¹ K çº¿æ•°æ®ä¼ è¾“åˆ° Web å›¾è¡¨
7. **æ€§èƒ½åˆ†æ**ï¼šå›æµ‹ç»“æŸåç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. BacktestEngineï¼ˆ`src/backtest/engine.py`ï¼‰

æ ¸å¿ƒå›æµ‹å¼•æ“ç±»ï¼Œè´Ÿè´£æ•´ä¸ªå›æµ‹æµç¨‹çš„ç¼–æ’ã€‚

#### åˆå§‹åŒ–å‚æ•°

```python
from src.backtest.engine import BacktestEngine

engine = BacktestEngine(
    initial_cash=10000.0,       # åˆå§‹èµ„é‡‘ï¼ˆUSDTï¼‰
    commission=0.0004,           # æ‰‹ç»­è´¹ç‡ï¼ˆ0.04%ï¼‰
    strategy_name='MyStrategy'   # ç­–ç•¥åç§°ï¼ˆç”¨äºæŠ¥å‘Šï¼‰
)
```

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `setup()` | strategy_class, strategy_params | None | è®¾ç½®ç­–ç•¥å’Œå‚æ•° |
| `load_data()` | csv_path, name | None | åŠ è½½ CSV æ•°æ® |
| `add_analyzer()` | analyzer_class | None | æ·»åŠ æ€§èƒ½åˆ†æå™¨ |
| `run()` | - | cerebro results | æ‰§è¡Œå›æµ‹ |
| `get_final_value()` | - | float | è·å–æœŸæœ«èµ„é‡‘ |
| `plot()` | output_dir | None | ç”Ÿæˆé™æ€å›¾è¡¨ |

#### å®Œæ•´ç¤ºä¾‹

```python
from src.backtest.engine import BacktestEngine
from src.strategy.RSIStrategy import RSIBacktraderStrategy

# 1. åˆ›å»ºå¼•æ“
engine = BacktestEngine(
    initial_cash=10000.0,
    commission=0.0004,
    strategy_name='BTC_RSI'
)

# 2. è®¾ç½®ç­–ç•¥
strategy_params = {
    'rsi_period': 14,
    'rsi_oversold': 30,
    'rsi_overbought': 70,
    'printlog': False
}
engine.setup(RSIBacktraderStrategy, strategy_params)

# 3. åŠ è½½æ•°æ®
engine.load_data(
    csv_path='data/btc-usdt-5m.csv',
    name='BTC/USDT'
)

# 4. æ·»åŠ åˆ†æå™¨ï¼ˆå¯é€‰ï¼‰
import backtrader as bt
engine.add_analyzer(bt.analyzers.SharpeRatio)
engine.add_analyzer(bt.analyzers.DrawDown)

# 5. è¿è¡Œå›æµ‹
results = engine.run()

# 6. è·å–ç»“æœ
final_value = engine.get_final_value()
print(f"æœŸæœ«èµ„é‡‘: {final_value:.2f} USDT")

# 7. ç”Ÿæˆå›¾è¡¨
engine.plot(output_dir='./reports')
```

### 2. quick_backtest å¿«æ·å‡½æ•°

ç®€åŒ–ç‰ˆæ¥å£ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•ã€‚

#### å‡½æ•°ç­¾å

```python
def quick_backtest(
    csv_path: str,                    # CSV æ–‡ä»¶è·¯å¾„
    strategy_class: Type[bt.Strategy], # ç­–ç•¥ç±»
    strategy_params: dict = None,      # ç­–ç•¥å‚æ•°
    initial_cash: float = 10000.0,     # åˆå§‹èµ„é‡‘
    commission: float = 0.0004,        # æ‰‹ç»­è´¹ç‡
    output_dir: str = None,            # æŠ¥å‘Šè¾“å‡ºç›®å½•
    strategy_name: str = 'Strategy'    # ç­–ç•¥åç§°
) -> dict
```

#### è¿”å›å€¼

```python
{
    'final_value': 8796.89,           # æœŸæœ«èµ„é‡‘
    'return_pct': -12.03,             # æ”¶ç›Šç‡ï¼ˆ%ï¼‰
    'sharpe_ratio': 0.45,             # å¤æ™®æ¯”ç‡
    'max_drawdown': -18.5,            # æœ€å¤§å›æ’¤ï¼ˆ%ï¼‰
    'total_trades': 87,               # æ€»äº¤æ˜“æ¬¡æ•°
    'win_rate': 52.3                  # èƒœç‡ï¼ˆ%ï¼‰
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```python
from src.backtest.engine import quick_backtest
from src.strategy.RSIStrategy import RSIBacktraderStrategy

results = quick_backtest(
    csv_path='data/btc-usdt-5m.csv',
    strategy_class=RSIBacktraderStrategy,
    strategy_params={
        'rsi_period': 14,
        'rsi_oversold': 30,
        'rsi_overbought': 70
    },
    initial_cash=10000.0,
    commission=0.0004,
    output_dir='./reports',
    strategy_name='BTC_RSI_5m'
)

print(f"æ”¶ç›Šç‡: {results['return_pct']:.2f}%")
print(f"å¤æ™®æ¯”ç‡: {results['sharpe_ratio']:.2f}")
print(f"æœ€å¤§å›æ’¤: {results['max_drawdown']:.2f}%")
```

## ğŸ“Š æ•°æ®åŠ è½½å™¨

### æ”¯æŒçš„æ•°æ®æ ¼å¼

`data_loader.py` è‡ªåŠ¨å¤„ç†ä»¥ä¸‹ CSV æ ¼å¼ï¼š

#### æ ¼å¼ 1ï¼šå¸¦æ—¶é—´æˆ³åˆ—

```csv
timestamp,datetime,open,high,low,close,volume
1718841600000,2025-06-20 00:00:00,66500.23,66750.89,66450.12,66680.45,123.456
```

#### æ ¼å¼ 2ï¼šä»…æ—¥æœŸæ—¶é—´åˆ—

```csv
datetime,open,high,low,close,volume
2025-06-20 00:00:00,66500.23,66750.89,66450.12,66680.45,123.456
```

#### æ ¼å¼ 3ï¼šç´¢å¼•ä¸ºæ—¥æœŸæ—¶é—´

```csv
,open,high,low,close,volume
2025-06-20 00:00:00,66500.23,66750.89,66450.12,66680.45,123.456
```

### è‡ªå®šä¹‰æ•°æ®åŠ è½½

å¦‚æœä½ çš„æ•°æ®æ ¼å¼ç‰¹æ®Šï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ Pandasï¼š

```python
import pandas as pd
import backtrader as bt

# è¯»å–è‡ªå®šä¹‰æ ¼å¼
df = pd.read_csv('data/custom_data.csv')

# æ•°æ®é¢„å¤„ç†
df['datetime'] = pd.to_datetime(df['timestamp'], unit='ms')
df = df.set_index('datetime')
df = df[['open', 'high', 'low', 'close', 'volume']]

# è½¬æ¢ä¸º Backtrader DataFeed
data = bt.feeds.PandasData(dataname=df)

# æ·»åŠ åˆ° Cerebro
cerebro = bt.Cerebro()
cerebro.adddata(data, name='BTC/USDT')
```

## ğŸ“ˆ å¯è§†åŒ–å›¾è¡¨

CryptoQuant æä¾›ä¸¤ç§å¯è§†åŒ–æ–¹å¼ï¼š

### 1. å®æ—¶ Web å›¾è¡¨ï¼ˆæ¨èï¼‰

åŸºäº **TradingView Lightweight Charts** çš„ç°ä»£åŒ– Web ç•Œé¢ã€‚

#### ç‰¹æ€§

- âœ… **å®æ—¶æ›´æ–°**ï¼šå›æµ‹è¿‡ç¨‹ä¸­åŠ¨æ€æ˜¾ç¤º K çº¿
- âœ… **äº¤äº’å¼æ“ä½œ**ï¼šç¼©æ”¾ã€å¹³ç§»ã€æ‚¬åœæŸ¥çœ‹æ•°æ®
- âœ… **ä¿¡å·æ ‡è®°**ï¼šè‡ªåŠ¨æ˜¾ç¤ºä¹°å–ä¿¡å·
- âœ… **é€æ ¹æ’­æ”¾**ï¼šå¯é€‰çš„åŠ¨ç”»æ’­æ”¾æ¨¡å¼
- âœ… **æš—é»‘ä¸»é¢˜**ï¼šä¿æŠ¤çœ¼ç›çš„å¤œé—´æ¨¡å¼
- âœ… **åˆ†ç¦»æˆäº¤é‡**ï¼šç‹¬ç«‹çš„æˆäº¤é‡å­å›¾

#### ä½¿ç”¨æ–¹å¼

```python
from src.backtest.engine import BacktestEngine

engine = BacktestEngine(initial_cash=10000.0)
engine.setup(MyStrategy, {})
engine.load_data('data/btc-usdt-5m.csv')

# å›æµ‹ä¼šè‡ªåŠ¨å¯åŠ¨ Web æœåŠ¡å™¨
engine.run()

# æµè§ˆå™¨è®¿é—® http://127.0.0.1:8765
```

#### å›¾è¡¨æ§åˆ¶

| æ“ä½œ | è¯´æ˜ |
|------|------|
| é¼ æ ‡æ»šè½® | ç¼©æ”¾æ—¶é—´è½´ |
| é¼ æ ‡æ‹–æ‹½ | å¹³ç§»è§†å›¾ |
| åŒå‡» | é‡ç½®åˆ°æœ€æ–°æ•°æ® |
| Playback å¤é€‰æ¡† | å¯ç”¨é€æ ¹æ’­æ”¾æ¨¡å¼ |
| Play/Pause æŒ‰é’® | æ§åˆ¶æ’­æ”¾/æš‚åœ |
| Speed ä¸‹æ‹‰èœå• | è°ƒæ•´æ’­æ”¾é€Ÿåº¦ |

#### ä¿¡å·æ ‡è®°é¢œè‰²

- ğŸ”µ **é’è‰²å‘ä¸Šç®­å¤´**ï¼ˆbelowBarï¼‰ï¼šä¹°å…¥ä¿¡å·
- ğŸŸ£ **ç´«è‰²å‘ä¸‹ç®­å¤´**ï¼ˆaboveBarï¼‰ï¼šå–å‡ºä¿¡å·
- ğŸŸ¡ **é»„è‰²æ–¹å—**ï¼ˆinBarï¼‰ï¼šå¹³ä»“ä¿¡å·

### 2. é™æ€å›¾è¡¨æŠ¥å‘Š

åŸºäº **Matplotlib/Seaborn** çš„ä¼ ç»Ÿå›¾è¡¨ã€‚

#### ç”Ÿæˆé™æ€æŠ¥å‘Š

```python
# å›æµ‹ç»“æŸåè°ƒç”¨
engine.plot(output_dir='./reports')
```

#### è¾“å‡ºæ–‡ä»¶

```
reports/
â”œâ”€â”€ BTC_RSI_5m_20250620_235959.png  # å›¾è¡¨å›¾ç‰‡
â””â”€â”€ BTC_RSI_5m_20250620_235959.txt  # æ–‡å­—æŠ¥å‘Š
```

## ğŸ“Š æ€§èƒ½åˆ†æå™¨

Backtrader å†…ç½®äº†ä¸°å¯Œçš„æ€§èƒ½åˆ†æå™¨ã€‚

### å¸¸ç”¨åˆ†æå™¨

```python
import backtrader as bt

# å¤æ™®æ¯”ç‡
engine.add_analyzer(bt.analyzers.SharpeRatio, _name='sharpe')

# æœ€å¤§å›æ’¤
engine.add_analyzer(bt.analyzers.DrawDown, _name='drawdown')

# äº¤æ˜“ç»Ÿè®¡
engine.add_analyzer(bt.analyzers.TradeAnalyzer, _name='trades')

# æ”¶ç›Šç‡
engine.add_analyzer(bt.analyzers.Returns, _name='returns')

# èƒœç‡
engine.add_analyzer(bt.analyzers.SQN, _name='sqn')
```

### è·å–åˆ†æç»“æœ

```python
results = engine.run()
strat = results[0]

# å¤æ™®æ¯”ç‡
sharpe = strat.analyzers.sharpe.get_analysis()
print(f"Sharpe Ratio: {sharpe['sharperatio']:.2f}")

# æœ€å¤§å›æ’¤
drawdown = strat.analyzers.drawdown.get_analysis()
print(f"Max Drawdown: {drawdown['max']['drawdown']:.2f}%")

# äº¤æ˜“ç»Ÿè®¡
trades = strat.analyzers.trades.get_analysis()
total = trades['total']['total']
won = trades['won']['total']
print(f"Total Trades: {total}")
print(f"Win Rate: {won/total*100:.2f}%")
```

### è‡ªå®šä¹‰åˆ†æå™¨

```python
import backtrader as bt

class MyAnalyzer(bt.Analyzer):
    def __init__(self):
        self.profit_list = []
    
    def notify_trade(self, trade):
        if trade.isclosed:
            self.profit_list.append(trade.pnl)
    
    def get_analysis(self):
        return {
            'total_profit': sum(self.profit_list),
            'avg_profit': sum(self.profit_list) / len(self.profit_list),
            'max_profit': max(self.profit_list),
            'min_profit': min(self.profit_list)
        }

# ä½¿ç”¨è‡ªå®šä¹‰åˆ†æå™¨
engine.add_analyzer(MyAnalyzer, _name='my_analyzer')
```

## âš™ï¸ é«˜çº§é…ç½®

### 1. ä¿®æ”¹æ‰‹ç»­è´¹æ¨¡å¼

```python
# å›ºå®šæ‰‹ç»­è´¹ç‡ï¼ˆé»˜è®¤ï¼‰
engine = BacktestEngine(commission=0.0004)

# åˆ†çº§æ‰‹ç»­è´¹ï¼ˆVIP ç”¨æˆ·ï¼‰
cerebro = bt.Cerebro()
cerebro.broker.setcommission(
    commission=0.0002,  # 0.02%
    leverage=1.0,
    margin=None
)
```

### 2. å¯ç”¨æ æ†äº¤æ˜“

```python
cerebro = bt.Cerebro()
cerebro.broker.setcommission(
    commission=0.0004,
    leverage=3.0,  # 3 å€æ æ†
    margin=0.33    # 33% ä¿è¯é‡‘
)
```

### 3. è®¾ç½®æ»‘ç‚¹

```python
cerebro.broker.set_slippage_perc(
    perc=0.001,  # 0.1% æ»‘ç‚¹
    slip_open=True,
    slip_limit=True,
    slip_match=True,
    slip_out=False
)
```

### 4. å¤šæ•°æ®æºå›æµ‹

```python
# åŠ è½½å¤šä¸ªäº¤æ˜“å¯¹
engine.load_data('data/btc-usdt-5m.csv', name='BTC/USDT')
engine.load_data('data/eth-usdt-5m.csv', name='ETH/USDT')

# ç­–ç•¥ä¸­è®¿é—®å¤šä¸ªæ•°æ®æº
class MultiAssetStrategy(bt.Strategy):
    def __init__(self):
        self.btc_close = self.datas[0].close
        self.eth_close = self.datas[1].close
    
    def next(self):
        btc_price = self.btc_close[0]
        eth_price = self.eth_close[0]
        
        # è®¡ç®— BTC/ETH æ¯”ç‡
        ratio = btc_price / eth_price
        
        if ratio > 20:
            self.sell(data=self.datas[0])  # å– BTC
            self.buy(data=self.datas[1])   # ä¹° ETH
```

### 5. åŠ¨æ€è°ƒæ•´å›¾è¡¨æ˜¾ç¤ºèŒƒå›´

æ¡†æ¶ä¼šè‡ªåŠ¨æ ¹æ®æ•°æ®é‡è°ƒæ•´ï¼š

```python
# åœ¨ engine.load_data() ä¸­è‡ªåŠ¨è®¡ç®—
row_count = len(df)
max_bars = int(row_count * 1.1)  # ç•™ 10% ä½™é‡
plotter.set_max_bars(max_bars)

# è¾“å‡ºç¤ºä¾‹ï¼š
# æ•°æ®è¡Œæ•°: 56160, è®¾ç½®å›¾è¡¨æœ€å¤§æ˜¾ç¤º: 61776
```

### 6. è°ƒæ•´å›¾è¡¨æ›´æ–°é¢‘ç‡

ä¿®æ”¹ `src/backtest/realtime_chart.py`ï¼š

```python
# åœ¨ HTML æ¨¡æ¿çš„ JavaScript ä¸­
function refresh() {
    fetch('/data')
        .then(response => response.json())
        .then(data => {
            // ... æ›´æ–°é€»è¾‘
        });
}

// é»˜è®¤ 1000msï¼ˆ1ç§’ï¼‰ï¼Œå¯æ”¹ä¸º 500msï¼ˆæ›´æµç•…ï¼‰
setInterval(refresh, 500);
```

### 7. ç¦ç”¨å®æ—¶å›¾è¡¨

å¦‚æœåªéœ€è¦é™æ€æŠ¥å‘Šï¼š

```python
# åœ¨ engine.py çš„ setup() æ–¹æ³•ä¸­
def setup(self, strategy_class, strategy_params=None):
    # æ³¨é‡Šæ‰è¿™è¡Œ
    # self.plotter = RealtimeChartPlotter()
    self.plotter = None
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æ•°æ®éªŒè¯

å›æµ‹å‰åŠ¡å¿…æ£€æŸ¥æ•°æ®è´¨é‡ï¼š

```python
import pandas as pd

df = pd.read_csv('data/btc-usdt-5m.csv')

# æ£€æŸ¥ç©ºå€¼
assert df.isnull().sum().sum() == 0, "æ•°æ®åŒ…å«ç©ºå€¼"

# æ£€æŸ¥ä»·æ ¼åˆç†æ€§
assert (df['high'] >= df['low']).all(), "é«˜ä»·ä½äºä½ä»·"
assert (df['high'] >= df['open']).all(), "é«˜ä»·ä½äºå¼€ç›˜ä»·"
assert (df['high'] >= df['close']).all(), "é«˜ä»·ä½äºæ”¶ç›˜ä»·"

# æ£€æŸ¥æ—¶é—´è¿ç»­æ€§
df['datetime'] = pd.to_datetime(df['datetime'])
time_diff = df['datetime'].diff().dt.total_seconds()
assert (time_diff[1:] == 300).all(), "æ—¶é—´é—´éš”ä¸æ˜¯ 5 åˆ†é’Ÿ"
```

### 2. å‚æ•°ä¼˜åŒ–

ä½¿ç”¨ Backtrader çš„ä¼˜åŒ–åŠŸèƒ½ï¼š

```python
cerebro = bt.Cerebro(optreturn=False)
cerebro.optstrategy(
    RSIBacktraderStrategy,
    rsi_period=range(10, 20, 2),       # 10, 12, 14, 16, 18
    rsi_oversold=range(20, 35, 5),     # 20, 25, 30
    rsi_overbought=range(65, 80, 5)    # 65, 70, 75
)

results = cerebro.run()

# æ‰¾åˆ°æœ€ä½³å‚æ•°ç»„åˆ
best_result = max(results, key=lambda x: x[0].broker.getvalue())
best_params = best_result[0].params
print(f"æœ€ä½³å‚æ•°: RSIå‘¨æœŸ={best_params.rsi_period}, "
      f"è¶…å–çº¿={best_params.rsi_oversold}, "
      f"è¶…ä¹°çº¿={best_params.rsi_overbought}")
```

### 3. å†…å­˜ä¼˜åŒ–

å¤„ç†å¤§æ•°æ®é›†æ—¶ï¼š

```python
# å¯ç”¨ exactbars æ¨¡å¼ï¼ˆä»…ä¿ç•™å¿…è¦çš„å†å²æ•°æ®ï¼‰
cerebro = bt.Cerebro(exactbars=-1)

# æˆ–è€…åˆ†æ‰¹å›æµ‹
date_ranges = [
    ('2024-01-01', '2024-03-31'),
    ('2024-04-01', '2024-06-30'),
    ('2024-07-01', '2024-09-30'),
    ('2024-10-01', '2024-12-31')
]

for start, end in date_ranges:
    df = pd.read_csv('data/btc-usdt-5m.csv')
    df = df[(df['datetime'] >= start) & (df['datetime'] <= end)]
    # ... æ‰§è¡Œå›æµ‹
```

---

ğŸ“Œ **ä¸‹ä¸€æ­¥**ï¼šé˜…è¯» [ç­–ç•¥å¼€å‘æ•™ç¨‹](./04-ç­–ç•¥å¼€å‘æ•™ç¨‹.md) å­¦ä¹ å¦‚ä½•ç¼–å†™è‡ªå·±çš„äº¤æ˜“ç­–ç•¥ã€‚
